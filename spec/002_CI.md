# tfbreak — CI/CD Specification

> Automated release management and binary distribution for tfbreak.

---

## 1. Overview

### 1.1 Purpose

Automate version management, changelog generation, and cross-platform binary releases using Release Please and GitHub Actions.

### 1.2 Goals

- Automatic version bumping based on Conventional Commits
- Generated changelogs from commit history
- Cross-platform binaries attached to GitHub releases
- Zero manual steps for releases
- Compatible with GitHub immutable releases

---

## 2. Release Management

### 2.1 Release Please

Uses `googleapis/release-please-action` v4 with manifest configuration.

| File | Purpose |
|------|---------|
| `release-please-config.json` | Release configuration, changelog sections, draft mode |
| `.release-please-manifest.json` | Current version tracking |

### 2.2 Version Bump Rules

| Commit Type | Example | Version Bump |
|-------------|---------|--------------|
| `feat` | `feat: add new command` | Minor |
| `fix` | `fix: correct parsing bug` | Patch |
| `deps` | `deps: update cobra to v1.9` | Patch |
| `feat!` or `BREAKING CHANGE` | Breaking change | Major |
| `chore`, `docs`, `test`, etc. | Maintenance | None |

### 2.3 Changelog Sections

Default sections (automatic):
- Features (`feat`)
- Bug Fixes (`fix`)

Custom section (configured):
- Dependencies (`deps`)

---

## 3. Build Configuration

### 3.1 Platforms

| OS | Architecture | Binary Name |
|----|--------------|-------------|
| Linux | amd64 | `tfbreak-linux-amd64` |
| Linux | arm64 | `tfbreak-linux-arm64` |
| macOS | amd64 | `tfbreak-darwin-amd64` |
| macOS | arm64 | `tfbreak-darwin-arm64` |
| Windows | amd64 | `tfbreak-windows-amd64.exe` |
| Windows | arm64 | `tfbreak-windows-arm64.exe` |

### 3.2 Build Flags

| Flag | Value | Purpose |
|------|-------|---------|
| `-trimpath` | enabled | Remove file system paths from binary |
| `-ldflags -s` | enabled | Strip symbol table |
| `-ldflags -w` | enabled | Strip DWARF debug info |
| `CGO_ENABLED` | 0 | Static binary, no C dependencies |

### 3.3 Version Injection

```bash
-X main.version=${VERSION}
-X main.commit=${COMMIT}
-X main.date=${DATE}
```

---

## 4. Workflow Architecture

### 4.1 Trigger

Push to `main` branch.

### 4.2 Draft Release Strategy

The workflow uses **draft releases** to support GitHub's immutable releases feature:

1. Release Please creates a **draft** release (not published)
2. Build job runs and uploads artifacts to the draft
3. After all artifacts are uploaded, the release is **published**
4. Publishing creates the git tag and makes the release immutable

This approach allows artifact uploads before the release becomes immutable.

### 4.3 Jobs

```
Push to main
     │
     ▼
┌──────────────────┐
│  release-please  │──── Creates/updates release PR
└──────────────────┘
     │ (on PR merge)
     ▼
┌──────────────────┐
│  release_created │
│  == true?        │
└──────────────────┘
     │ yes
     ▼
┌──────────────────┐
│  Draft release   │──── Created (no tag yet)
└──────────────────┘
     │
     ▼
┌──────────────────┐
│  build (matrix)  │──── 6 platform builds from SHA
└──────────────────┘
     │
     ▼
┌──────────────────┐
│  upload-assets   │──── Attach binaries to draft
└──────────────────┘
     │
     ▼
┌──────────────────┐
│  publish release │──── gh release edit --draft=false
└──────────────────┘
     │
     ▼
┌──────────────────┐
│  Tag created     │──── Release now immutable
└──────────────────┘
```

### 4.4 Critical: Build from Commit SHA

The build job checks out code at the **commit SHA**, not the tag:

```yaml
ref: ${{ needs.release-please.outputs.sha }}
```

This is required because draft releases don't create tags until published.

---

## 5. Configuration Files

### 5.1 release-please-config.json

```json
{
  "$schema": "https://raw.githubusercontent.com/googleapis/release-please/main/schemas/config.json",
  "release-type": "go",
  "draft": true,
  "packages": {
    ".": {
      "component": "tfbreak"
    }
  },
  "changelog-sections": [
    {"type": "deps", "section": "Dependencies"}
  ],
  "include-component-in-tag": false
}
```

Notes:
- `draft: true` - Creates releases as drafts for immutable release compatibility
- `feat` and `fix` changelog sections are included automatically

### 5.2 .release-please-manifest.json

```json
{
  ".": "0.1.0"
}
```

---

## 6. Verification

### 6.1 Local Build

```bash
make build
./bin/tfbreak version
# Output should show git commit and build date
```

### 6.2 Release Workflow

1. Push conventional commit to main
2. Release Please creates PR
3. Merge PR creates **draft** release
4. Build workflow produces 6 binaries
5. Binaries uploaded to draft release
6. Release published → tag created, release immutable
7. Download binary, verify: `./tfbreak version` shows correct version
