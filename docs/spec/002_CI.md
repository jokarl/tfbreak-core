# tfbreak — CI/CD Specification

> Automated validation, release management, and binary distribution for tfbreak.

---

## 1. Overview

### 1.1 Purpose

Provide automated code validation on pull requests and automated release management using GitHub Actions.

### 1.2 Goals

**Continuous Integration (PR Validation):**
- Validate code compiles before merge
- Run tests with race detection
- Static analysis via `go vet`
- Security vulnerability scanning via `govulncheck`
- Fast feedback for contributors

**Continuous Delivery (Releases):**
- Automatic version bumping based on Conventional Commits
- Generated changelogs from commit history
- Cross-platform binaries attached to GitHub releases
- Zero manual steps for releases
- Compatible with GitHub immutable releases

---

## 2. PR Validation Workflow

### 2.1 Trigger

Pull requests targeting the `main` branch.

### 2.2 Job Structure

The workflow uses a **build-first, parallel-validation** pattern:

```
Pull Request to main
     │
     ▼
┌──────────────────┐
│      build       │──── go build ./...
└──────────────────┘
     │ (success)
     ├─────────────────┬─────────────────┐
     ▼                 ▼                 ▼
┌──────────┐    ┌──────────┐    ┌──────────────┐
│   test   │    │   vet    │    │  vulncheck   │
└──────────┘    └──────────┘    └──────────────┘
     │                 │                 │
     └─────────────────┴─────────────────┘
                       │
                       ▼
              PR Status Updated
```

### 2.3 Jobs

| Job | Command | Purpose |
|-----|---------|---------|
| `build` | `go build ./...` | Verify compilation |
| `test` | `go test -race -v ./...` | Run tests with race detection |
| `vet` | `go vet ./...` | Static analysis |
| `vulncheck` | `govulncheck ./...` | Security vulnerability scan |

### 2.4 Parallelization

After the build job succeeds, test, vet, and vulncheck run **in parallel**:

- **Sequential time**: ~45 seconds (build: 5s + test: 30s + vet: 5s + vulncheck: 5s)
- **Parallel time**: ~35 seconds (build: 5s + max(test, vet, vulncheck))
- **Time saved**: ~10 seconds per run (~22% reduction)

### 2.5 Environment

All jobs use:
- Runner: `ubuntu-latest`
- Go version: from `go.mod`
- Go module caching: enabled via `actions/setup-go@v5`

### 2.6 Permissions

Minimal permissions for security:
```yaml
permissions:
  contents: read
```

---

## 3. Release Management

### 3.1 Release Please

Uses `googleapis/release-please-action` v4 with manifest configuration.

| File | Purpose |
|------|---------|
| `release-please-config.json` | Release configuration, changelog sections, draft mode |
| `.release-please-manifest.json` | Current version tracking |

### 3.2 Version Bump Rules

| Commit Type | Example | Version Bump |
|-------------|---------|--------------|
| `feat` | `feat: add new command` | Minor |
| `fix` | `fix: correct parsing bug` | Patch |
| `deps` | `deps: update cobra to v1.9` | Patch |
| `feat!` or `BREAKING CHANGE` | Breaking change | Major |
| `chore`, `docs`, `test`, etc. | Maintenance | None |

### 3.3 Changelog Sections

Default sections (automatic):
- Features (`feat`)
- Bug Fixes (`fix`)

Custom section (configured):
- Dependencies (`deps`)

---

## 4. Build Configuration

### 4.1 Platforms

| OS | Architecture | Binary Name |
|----|--------------|-------------|
| Linux | amd64 | `tfbreak-linux-amd64` |
| Linux | arm64 | `tfbreak-linux-arm64` |
| macOS | amd64 | `tfbreak-darwin-amd64` |
| macOS | arm64 | `tfbreak-darwin-arm64` |
| Windows | amd64 | `tfbreak-windows-amd64.exe` |
| Windows | arm64 | `tfbreak-windows-arm64.exe` |

### 4.2 Build Flags

| Flag | Value | Purpose |
|------|-------|---------|
| `-trimpath` | enabled | Remove file system paths from binary |
| `-ldflags -s` | enabled | Strip symbol table |
| `-ldflags -w` | enabled | Strip DWARF debug info |
| `CGO_ENABLED` | 0 | Static binary, no C dependencies |

### 4.3 Version Injection

```bash
-X main.version=${VERSION}
-X main.commit=${COMMIT}
-X main.date=${DATE}
```

---

## 5. Release Workflow Architecture

### 5.1 Trigger

Push to `main` branch.

### 5.2 Draft Release Strategy

The workflow uses **draft releases** to support GitHub's immutable releases feature:

1. Release Please creates a **draft** release (not published)
2. Build job runs and uploads artifacts to the draft
3. After all artifacts are uploaded, the release is **published**
4. Publishing creates the git tag and makes the release immutable

This approach allows artifact uploads before the release becomes immutable.

### 5.3 Jobs

```
Push to main
     │
     ▼
┌──────────────────┐
│  release-please  │──── Creates/updates release PR
└──────────────────┘
     │ (on PR merge)
     ▼
┌──────────────────┐
│  release_created │
│  == true?        │
└──────────────────┘
     │ yes
     ▼
┌──────────────────┐
│  Draft release   │──── Created (no tag yet)
└──────────────────┘
     │
     ▼
┌──────────────────┐
│  build (matrix)  │──── 6 platform builds from SHA
└──────────────────┘
     │
     ▼
┌──────────────────┐
│  upload-assets   │──── Attach binaries to draft
└──────────────────┘
     │
     ▼
┌──────────────────┐
│  publish release │──── gh release edit --draft=false
└──────────────────┘
     │
     ▼
┌──────────────────┐
│  Tag created     │──── Release now immutable
└──────────────────┘
```

### 5.4 Critical: Build from Commit SHA

The build job checks out code at the **commit SHA**, not the tag:

```yaml
ref: ${{ needs.release-please.outputs.sha }}
```

This is required because draft releases don't create tags until published.

---

## 6. Configuration Files

### 6.1 release-please-config.json

```json
{
  "$schema": "https://raw.githubusercontent.com/googleapis/release-please/main/schemas/config.json",
  "release-type": "go",
  "draft": true,
  "packages": {
    ".": {
      "component": "tfbreak"
    }
  },
  "changelog-sections": [
    {"type": "deps", "section": "Dependencies"}
  ],
  "include-component-in-tag": false
}
```

Notes:
- `draft: true` - Creates releases as drafts for immutable release compatibility
- `feat` and `fix` changelog sections are included automatically

### 6.2 .release-please-manifest.json

```json
{
  ".": "0.1.0"
}
```

---

## 7. Verification

### 7.1 Local Build

```bash
make build
./bin/tfbreak version
# Output should show git commit and build date
```

### 7.2 Release Workflow

1. Push conventional commit to main
2. Release Please creates PR
3. Merge PR creates **draft** release
4. Build workflow produces 6 binaries
5. Binaries uploaded to draft release
6. Release published → tag created, release immutable
7. Download binary, verify: `./tfbreak version` shows correct version
